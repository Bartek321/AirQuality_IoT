<html>
  <head>
    <script src="https://d3js.org/d3.v4.js"></script>
    <script src="https://unpkg.com/d3-fetch"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <style>
    body {
        font-family: Arial;
    }
	
    * {
      box-sizing: border-box;
    }

    .box {
      float: left;
      width: 50%;
      padding: 20px;

    }
    .center {
      margin: auto;
    }


    .clearfix::after {
      content: "";
      clear: both;
      display: table;
    }
    </style>


<link rel="stylesheet" type="text/css" href="stylesheet.css">
</head>
<body>
<div class="tabbar">
	<a href=page.html class="button2" id="buttona">Plan</a>
	<a href=page.html class="button2" id="buttonb">Konfiguracja</a>
	<a href=page6.html class="button2">Dane</a>
	<a href=page.html class="button2" id="buttonc">Opcje</a>
	<a href=page.html class="button" id="button1">O2</a>-
	<a href=page.html class="button2" id="button2">O3</a>
	<input class="filetag" type="file" id="filetag"/>
</div>

      
    <div class="clearfix" style= "float: left; ">
    	<div id="curve_chart1"  class="box" style="width: 1600px; height: 1200px">
	<div class="btn-group btn-group-md" role="group" aria-label="Small button group" style= "position: fixed; left: 50%; margin-top: 20px; transform: translate(-50%, -50%);">	
	<button class="btn btn-secondary" id="sensor_1" type="button" style="color:black; background-color: #C8C8C8; border-radius: 0px">Temperatura A</button>
	<button class="btn btn-secondary" id="sensor_2" type="button" style="color:black; background-color: #C8C8C8; border-radius: 0px">Wilgotnosc A</button>
	<button class="btn btn-secondary" id="sensor_3" type="button" style="color:black; background-color: #C8C8C8; border-radius: 0px">Tlenek wegla A</button>
	<button class="btn btn-secondary" id="sensor_4" type="button" style="color:black; background-color: #C8C8C8; border-radius: 0px">Wibracje A</button>
	<button class="btn btn-secondary" id="sensor_5" type="button" style="color:black; background-color: #C8C8C8; border-radius: 0px">PM 2.5 A</button>
	<button class="btn btn-secondary" id="sensor_6" type="button" style="color:black; background-color: #C8C8C8; border-radius: 0px">PM 1 A</button>
	<button class="btn btn-secondary" id="sensor_7" type="button" style="color:black; background-color: #C8C8C8; border-radius: 0px">PM 10 A</button>
	</div>
	<div class="btn-group btn-group-md" role="group" aria-label="Small button group" style= "position: fixed; left: 50%; margin-top: 60px; transform: translate(-50%, -50%);">
	<button class="btn btn-secondary id="sensor_8" type="button" style="color:black; background-color: #C8C8C8; border-radius: 0px"> Temperatura B</button>
	<button class="btn btn-secondary id="sensor_9" type="button" style="color:black; background-color: #C8C8C8; border-radius: 0px">Wilgotnosc B</button>
	<button class="btn btn-secondary id="sensor_10" type="button" style="color:black; background-color: #C8C8C8; border-radius: 0px" >Tlenek wegla B</button>
	<button class="btn btn-secondary id="sensor_11" type="button" style="color:black; background-color: #C8C8C8; border-radius: 0px">Wibracje B</button>
	<button class="btn btn-secondary id="sensor_12" type="button" style="color:black; background-color: #C8C8C8; border-radius: 0px">PM 2.5 B</button>
	<button class="btn btn-secondary id="sensor_13" type="button" style="color:black; background-color: #C8C8C8; border-radius: 0px">PM 1 B</button>
	<button class="btn btn-secondary id="sensor_14" type="button" style="color:black; background-color: #C8C8C8; border-radius: 0px">PM 10 B</button>
	</div>
	<br>

	<svg id="svg1" width="710" height="460" style= "position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%);"></svg>
	</div>
    <script>
    var b1 = d3.select("#sensor_1")
    var b2 = d3.select("#sensor_2")
    var b3 = d3.select("#sensor_3")
    var b4 = d3.select("#sensor_4")
    var b5 = d3.select("#sensor_5")
    var b6 = d3.select("#sensor_6")
    var b7 = d3.select("#sensor_7")
    var b8 = d3.select("#sensor_8")
    var b9 = d3.select("#sensor_9")
    var b10 = d3.select("#sensor_10")
    var b11 = d3.select("#sensor_11")
    var b12 = d3.select("#sensor_12")
    var b13 = d3.select("#sensor_13")
    var b14 = d3.select("#sensor_14")


    console.log("Socket");
    var socket = new WebSocket('ws://127.0.0.1:50092');
    socket.onopen = function() {
        console.log('Connected!');
	var now = new Date();
    
	timestamp_now = now.getFullYear() +"-"+ pad(now.getMonth()+1) +"-"+ pad(now.getDate()) +" "+ pad(now.getHours()) +":"+ pad(now.getMinutes()) +":"+ pad(now.getSeconds())
	var starting_json = {"json_id": "7","timestamp_start": "2020-04-07 09:00:00","timestamp_end":timestamp_now ,"sensor_id": 1} 
    	first_json = JSON.stringify(starting_json)
        socket.send(first_json);
	console.log(first_json)
    };
    socket.onmessage = function(event) {
	var obj = JSON.parse(event.data.replace(/\bNaN\b/g, "null"));
        //var obj = JSON.parse(event.data);
        records = obj.result[0].data

	for (r in records)
	{ 	
 		records[r].timestamp = Date.parse(records[r].timestamp)
	}
	console.log("records")
	console.log(records)
        main(records);
        socket.close();
    };
    socket.onclose = function() {
        console.log('Lost connection!');
    };
    socket.onerror = function() {
        console.log('Error!');
    };
      // set the dimensions and margins of the graph
      var margin = {top: 30, right: 30, bottom: 60, left: 60},
          width = 1000 - margin.left - margin.right,
          height = 750 - margin.top - margin.bottom;
      
      // append the svg object to the body of the page
      var svga = d3.select("#svg1")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
        .append("g")
          .attr("transform",
                "translate(" + margin.left + "," + margin.top + ")");

      svga.append("text").attr('id', 'bottom_axis_text')             
        .attr("transform", "translate(" + (width/2) + " ," +  (height + margin.top + 25) + ")")
        .style("text-anchor", "middle").style("font-size","20px")
        .text("Data pomiaru ");


      svga.append("text").attr('id', 'left_axis_text')
        .attr("transform", "rotate(-90)")
        .attr("y", 0 - margin.left)
        .attr("x",0 - (height / 2))
        .attr("dy", "1em")
        .style("text-anchor", "middle").style("font-size","20px")
        .text("T [Â°C]"); 
    function pad(n){return n<10 ? '0'+n : n}
    function main(data) {

    	var current_sensor = 1;
	b1.on("click", function () {buttonX(1); });
	b8.on("click", function () {buttonX(2); });

	b2.on("click", function () {buttonX(9); });
	b9.on("click", function () {buttonX(10); });

	b3.on("click", function () {buttonX(3); });
	b10.on("click", function () {buttonX(4); });

	b4.on("click", function () {buttonX(7); });
	b11.on("click", function () {buttonX(8); });

	b5.on("click", function () {buttonX(5); });
	b12.on("click", function () {buttonX(6); });

	b6.on("click", function () {buttonX(11); });
	b13.on("click", function () {buttonX(12); });

	b7.on("click", function () {buttonX(13); });	
	b14.on("click", function () {buttonX(14); });



      var x = d3.scaleUtc()
        .domain(d3.extent(data, function(d) { return d.timestamp; }))
        .range([ 0, width ]);
      xAxis = svga.append("g").style("font-size","16px")
        .attr("transform", "translate(0," + height + ")")
        .call(d3.axisBottom(x));
  
      // Add Y axis
      var y = d3.scaleLinear()
        .domain([0, d3.max(data, function(d) { return +d.value; })])
        .range([ height, 0 ]);
      yAxis = svga.append("g").style("font-size","16px")
        .call(d3.axisLeft(y));
  
      // Add a clipPath: everything out of this area won't be drawn.
      var clip = svga.append("defs").append("svga:clipPath")
          .attr("id", "clipa")
          .append("svga:rect")
          .attr("width", width )
          .attr("height", height )
          .attr("x", 0)
          .attr("y", 0);
  
      // Add brushing
      var brush = d3.brushX()                   // Add the brush feature using the d3.brush function
          .extent( [ [0,0], [width,height] ] )  // initialise the brush area: start at 0,0 and finishes at width,height: it means I select the whole graph area
          .on("end", updateChart)               // Each time the brush selection changes, trigger the 'updateChart' function
  
      // Create the line variable: where both the line and the brush take place
      var line = svga.append('g')
        .attr("clip-path", "url(#clipa)")

  
      // Add the line
      line.append("path")
        .data([data])
        .attr("class", "line")  // I add the class line to be able to modify this line later on.
        .attr("fill", "none")
        .attr("stroke", "black")
        .attr("stroke-width", 1.5)
        .attr("d", d3.line()
          .x(function(d) { return x(+d.timestamp) })
          .y(function(d) { return y(+d.value) })
          )


  
      // Add the brushing
      line
        .append("g")
          .attr("class", "brush")
          .call(brush);
  
      // A function that set idleTimeOut to null
      var idleTimeout
      function idled() { idleTimeout = null; }

      function buttonX(button_id) {
	current_sensor = button_id
	var now = new Date();  
	timestamp_now = now.getFullYear() +"-"+ pad(now.getMonth()+1) +"-"+ pad(now.getDate()) +" "+ pad(now.getHours()) +":"+ pad(now.getMinutes()) +":"+ pad(now.getSeconds())

	new_json = JSON.stringify({"json_id": "7","timestamp_start": "2020-04-07 09:00:00","timestamp_end":timestamp_now, "sensor_id": current_sensor})

        var socket = new WebSocket('ws://127.0.0.1:50092');
        socket.onopen = function() {console.log('Connected!');
        socket.send(new_json);};
        socket.onmessage = function(event) {
            var button_obj = JSON.parse(event.data.replace(/\bNaN\b/g, "null"));
            var button_records = button_obj.result[0].data

            for (r in button_records)
            { 	
                button_records[r].timestamp = Date.parse(button_records[r].timestamp)
            }
	    first_record = button_records[0].timestamp
	    fd = new Date(first_record)
	    fd = fd.toLocaleDateString();	    	    
	    last_record = button_records[button_records.length - 1].timestamp
	    ld = new Date(last_record)
	    ld = ld.toLocaleDateString();

	axis_text = d3.select("#left_axis_text")
	bottom_text = d3.select("#bottom_axis_text")
	bottom_text.text("Zakres dat: "+fd+" - "+ld)
        switch (current_sensor) {
        case 1:
            axis_text.text("Temperatura [ C]");
            break;

        case 2:
            axis_text.text("Temperatura [ C]")
            break;

        case 3:
            axis_text.text("Tlenek wegla [ppm]")
            break;

        case 4:
            axis_text.text("Tlenek wegla [ppm]")
            break;

        case 9:
            axis_text.text("Wilgotnosc [%RH]")
            break;

        case 10:
            axis_text.text("Wilgotnosc [%RH]")
            break;

        case 7:
            axis_text.text("Wibracje [Hz]")
            break;

        case 8:
            axis_text.text("Wibracje [Hz]")
            break;

        case 5:
            axis_text.text("PM 2.5 [ug/m3]")
            break;

        case 6:
            axis_text.text("PM 2.5 [ug/m3]")
            break;

        case 11:
            axis_text.text("PM 1 [ug/m3]")
            break;

        case 12:
            axis_text.text("PM 1 [ug/m3]")
            break;

        case 13:
            axis_text.text("PM 10 [ug/m3]")
            break;

        case 14:
            axis_text.text("PM 10 [ug/m3]")
            break;
           
        default:
            axis_text.text("Nie obslugiwana jednostka")
        }


        var button_data = svga.selectAll(".line")
            .data([button_records], function(d){ return d.value });

        button_data
            .enter()
            .append("path")
            .attr("class","line")
            .merge(button_data)
            .transition()
            .duration(600)
            .attr("d", d3.line()
            .x(function(d) { return x(d.timestamp); })
            .y(function(d) { return y(d.value); }))
            .attr("fill", "none")
            .attr("stroke", "black")
            .attr("stroke-width", 1.5)

        x.domain(d3.extent(button_records, function(d) { return d.timestamp; }))
          .range([ 0, width ]);
	
        // Add Y axis
        y.domain([0, d3.max(button_records, function(d) { return +d.value; })])
          .range([ height, 0 ]);

        xAxis.transition().call(d3.axisBottom(x))
        yAxis.transition().call(d3.axisLeft(y))

        socket.close();
        };
        socket.onclose = function() {
            console.log('Lost connection!');
        };
        socket.onerror = function() {
            console.log('Error!');
        };
             
        }
          
  
      // A function that update the chart for given boundaries
    function updateChart() {
  
        extent = d3.event.selection


    if(!extent){
        if (!idleTimeout) return idleTimeout = setTimeout(idled, 350); // This allows to wait a little bit
        x.domain([ 4,8])
    }else{
        l = x.invert(extent[0])
        r = x.invert(extent[1])

        x.domain([ x.invert(extent[0]), x.invert(extent[1]) ])

        console.log(l+"	"+r);

        timestamp_left = l.getFullYear() +"-"+ pad(l.getMonth()+1) +"-"+ pad(l.getDate()) +" "+ pad(l.getHours()) +":"+ pad(l.getMinutes()) +":"+ pad(l.getSeconds())
        timestamp_right = r.getFullYear() +"-"+ pad(r.getMonth()+1) +"-"+ pad(r.getDate()) +" "+ pad(r.getHours()) +":"+ pad(r.getMinutes()) +":"+ pad(r.getSeconds())


        var json_builder = {"json_id": "7","timestamp_start": timestamp_left,"timestamp_end": timestamp_right,"sensor_id": current_sensor} 
        new_json = JSON.stringify(json_builder)
        console.log(new_json)
        var socket = new WebSocket('ws://127.0.0.1:50092');
        socket.onopen = function() {console.log('Connected!');
        socket.send(new_json);};
        socket.onmessage = function(event) {
            var new_obj = JSON.parse(event.data.replace(/\bNaN\b/g, "null"));
            var new_records = new_obj.result[0].data

            for (r in new_records)
            { 	
                new_records[r].timestamp = Date.parse(new_records[r].timestamp)
	    }

	y.domain([d3.min(new_records, function(d) { return +d.value; }), d3.max(new_records, function(d) { return +d.value; })])
	    .range([ height, 0 ]);


    var u = svga.selectAll(".line")
        .data([new_records], function(d){ return d.value });

    u
        .enter()
        .append("path")
        .attr("class","line")
        .merge(u)
        .transition()
        .duration(600)
        .attr("d", d3.line()
        .x(function(d) { return x(d.timestamp); })
        .y(function(d) { return y(d.value); }))
        .attr("fill", "none")
        .attr("stroke", "black")
        .attr("stroke-width", 2.0)
        xAxis.transition().call(d3.axisBottom(x))
	yAxis.transition().call(d3.axisLeft(y))

                socket.close();
        };
        socket.onclose = function() {
            console.log('Lost connection!');
        };
        socket.onerror = function() {
            console.log('Error!');
        };
        line.select(".brush").call(brush.move, null)        
        }
    }      
        svga.on("dblclick",function(){
        var socket = new WebSocket('ws://127.0.0.1:50092');
        socket.onopen = function() {
            console.log('Connected!');
        var now = new Date();
            timestamp_now = now.getFullYear() +"-"+ pad(now.getMonth()+1) +"-"+ pad(now.getDate()) +" "+ pad(now.getHours()) +":"+ pad(now.getMinutes()) +":"+ pad(now.getSeconds())
        var db_click_json = {"json_id": "7","timestamp_start": "2020-04-08 00:00:00","timestamp_end": timestamp_now,"sensor_id": current_sensor}
            db_json = JSON.stringify(db_click_json)
            console.log(db_json);

            socket.send(db_json);
        };
        socket.onmessage = function(event) {
            var obj = JSON.parse(event.data.replace(/\bNaN\b/g, "null"));
            records = obj.result[0].data
            
        for (r in records)
        {	
            records[r].timestamp = Date.parse(records[r].timestamp)
        }
        x.domain(d3.extent(records, function(d) { return d.timestamp; }))
            .range([ 0, width ]);
	y.domain([0, d3.max(records, function(d) { return +d.value; })])
	    .range([ height, 0 ]);


    var z = svga.selectAll(".line")
        .data([records], function(d){ return d.value });

    z
        .enter()
        .append("path")
        .attr("class","line")
        .merge(z)
        .transition()
        .duration(600)
        .attr("d", d3.line()
        .x(function(d) { return x(d.timestamp); })
        .y(function(d) { return y(d.value); }))
        .attr("fill", "none")
        .attr("stroke", "black")
        .attr("stroke-width", 1.5)
        xAxis.transition().call(d3.axisBottom(x))
	yAxis.transition().call(d3.axisLeft(y))

        socket.close();


        };
        socket.onclose = function() {
            console.log('Lost connection!');
        };
        socket.onerror = function() {
            console.log('Error!');
        };


        });  
    }
  </script>   
    </div>
 
 
  </body>
</html>
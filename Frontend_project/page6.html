<html>
  <head>
    <script src="https://d3js.org/d3.v4.js"></script>
  <script src="https://unpkg.com/d3-fetch"></script>
    <style>
    body {
        font-family: Arial;
    }
        
    ul {
      list-style-type: none;
      margin: 0;
      padding: 0;
      overflow: hidden;
      background-color: lightblue; 
    }

    li {
      float: left;

    }

    li a {
      display: block;
      color: black;
      text-align: center;
      padding: 6px 40px;
      text-decoration: none;
      font-size: 16px;
    }

    * {
      box-sizing: border-box;
    }

    .box {
      float: left;
      width: 50%;
      padding: 20px;

    }
    .center {
      margin: auto;
    }


    .clearfix::after {
      content: "";
      clear: both;
      display: table;
    }
    </style>

    
  </head>
  <body>
    <ul>
      <li><a>Lokalizacja:   A</a></li>
      <li><a>Pyły PM2.5:    165</a></li>
      <li><a>Temperatura:   15°C</a></li>
      <li><a>Wilgotność:    35%</a></li>
      <li><a>Tlenek Węgla:  0</a></li>
      <li><a>Wibracje:  0</a></li>
    </ul>
    <ul>
      <li><a>Lokalizacja:   B</a></li>
      <li><a>Pyły PM2.5:    135</a></li>
      <li><a>Temperatura:   19°C</a></li>
      <li><a>Wilgotność:    45%</a></li>
      <li><a>Tlenek Węgla:  0</a></li>
      <li><a>Wibracje:  4</a></li>
    </ul>
      
    <div class="clearfix" style= "float: left; ">
    <div id="curve_chart1"  class="box" style="width: 800px; height: 500px"></div>  
    <script>

    var socket = new WebSocket('ws://127.0.0.1:50092');
    socket.onopen = function() {
        console.log('Connected!');
        socket.send('{"json_id": "2","timestamp_start": "2019-07-20 18:32:57","timestamp_end": "2020-04-10 18:32:57","sensor_id": 1}');
    };
    socket.onmessage = function(event) {
        var obj = JSON.parse(event.data);
        records = obj.result[0].data
	
	for (r in records)
	{
		//x = Date.parse(records[r].timestamp)
		//records[r].timestamp = new Date(x);  	
 		records[r].timestamp = Date.parse(records[r].timestamp)
		if (records[r].value > 100){
		records[r].value = 100}
	
	}
	console.log(records);
        main(records);
        socket.close();
    };
    socket.onclose = function() {
        console.log('Lost connection!');
    };
    socket.onerror = function() {
        console.log('Error!');
    };
      // set the dimensions and margins of the graph
      var margin = {top: 10, right: 30, bottom: 30, left: 60},
          width = 710 - margin.left - margin.right,
          height = 460 - margin.top - margin.bottom;
      
      // append the svg object to the body of the page
      var svg = d3.select("#curve_chart1")
        .append("svg")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
        .append("g")
          .attr("transform",
                "translate(" + margin.left + "," + margin.top + ")");

      svg.append("text")             
        .attr("transform", "translate(" + (width/2) + " ," +  (height + margin.top + 20) + ")")
        .style("text-anchor", "middle")
        .text("Data");


      svg.append("text")
        .attr("transform", "rotate(-90)")
        .attr("y", 0 - margin.left)
        .attr("x",0 - (height / 2))
        .attr("dy", "1em")
        .style("text-anchor", "middle")
        .text("Temperatura [°C]"); 
  
      var  dta =   
      [
      {date:0, value: 24.12 },
{date:1, value: 24.185 },
{date:2, value: 24.060000000000002 },
{date:3, value: 24.105 },
{date:4, value: 24.16 },
{date:5, value: 24.225 },
{date:6, value: 24.33 },
{date:7, value: 24.205000000000002 },
{date:8, value: 24.38 },
{date:9, value: 24.225 },
{date:10, value: 24.45 }
      ]
          
    function main(data) {

      var x = d3.scaleTime()
        .domain(d3.extent(data, function(d) { return d.timestamp; }))
        .range([ 0, width ]);
      xAxis = svg.append("g")
        .attr("transform", "translate(0," + height + ")")
        .call(d3.axisBottom(x));
  
      // Add Y axis
      var y = d3.scaleLinear()
        .domain([0, d3.max(data, function(d) { return +d.value; })])
        .range([ height, 0 ]);
      yAxis = svg.append("g")
        .call(d3.axisLeft(y));
  
      // Add a clipPath: everything out of this area won't be drawn.
      var clip = svg.append("defs").append("svg:clipPath")
          .attr("id", "clip")
          .append("svg:rect")
          .attr("width", width )
          .attr("height", height )
          .attr("x", 0)
          .attr("y", 0);
  
      // Add brushing
      var brush = d3.brushX()                   // Add the brush feature using the d3.brush function
          .extent( [ [0,0], [width,height] ] )  // initialise the brush area: start at 0,0 and finishes at width,height: it means I select the whole graph area
          .on("end", updateChart)               // Each time the brush selection changes, trigger the 'updateChart' function
  
      // Create the line variable: where both the line and the brush take place
      var line = svg.append('g')
        .attr("clip-path", "url(#clip)")
  
      // Add the line
      line.append("path")
        .datum(data)
        .attr("class", "line")  // I add the class line to be able to modify this line later on.
        .attr("fill", "none")
        .attr("stroke", "green")
        .attr("stroke-width", 2.5)
        .attr("d", d3.line()
          .x(function(d) { return x(d.timestamp) })
          .y(function(d) { return y(d.value) })
          )
  
      // Add the brushing
      line
        .append("g")
          .attr("class", "brush")
          .call(brush);
  
      // A function that set idleTimeOut to null
      var idleTimeout
      function idled() { idleTimeout = null; }
  
      // A function that update the chart for given boundaries
      function updateChart() {
  
        // What are the selected boundaries?
        extent = d3.event.selection








        // If no selection, back to initial coordinate. Otherwise, update X axis domain
        if(!extent){
          if (!idleTimeout) return idleTimeout = setTimeout(idled, 350); // This allows to wait a little bit
          x.domain([ 4,8])
        }else{
          x.domain([ x.invert(extent[0]), x.invert(extent[1]) ])
	  left = x.invert(extent[0])
	  right = x.invert(extent[1])
	  var l_year = left.getFullYear();
	  var l_month = left.getMonth();
	  var l_day = left.getDay();
	  var l_hour = left.getHours();
	  var l_min = left.getMinutes();
	  var l_sec = left.getSeconds();

	  var r_year = right.getFullYear();
	  var r_month = right.getMonth();
	  var r_day = right.getDay();
	  var r_hour = right.getHours();
	  var r_min = right.getMinutes();
	  var r_sec = right.getSeconds();
	  left = l_year +"-"+ l_month +"-"+ l_day +" "+ l_hour +":"+ l_min +":"+ l_sec
	  var json_builder = {"json_id": "2","timestamp_start": left,"timestamp_end": right,"sensor_id": 1}
	  new_json = JSON.stringify(json_builder)
          var socket = new WebSocket('ws://127.0.0.1:50092');
    	  socket.onopen = function() {console.log('Connected!');
          socket.send(new_json);};
    	  socket.onmessage = function(event) {
        	var new_obj = JSON.parse(event.data);
        	var new_records = new_obj.result[0].data
	
		for (r in new_records)
		{ 	
 		new_records[r].timestamp = Date.parse(new_records[r].timestamp)
		if (new_records[r].value > 100){
		new_records[r].value = 100}
		console.log(new_records)
		}
	
	        socket.close();
    };
    	  socket.onclose = function() {
        	console.log('Lost connection!');
    	  };
    	  socket.onerror = function() {
        	console.log('Error!');
    	  };

	









          line.select(".brush").call(brush.move, null) // This remove the grey brush area as soon as the selection has been done
        }
  
        // Update axis and line position
        xAxis.transition().duration(1000).call(d3.axisBottom(x))
        line
            .select('.line')
            .transition()
            .duration(1000)
            .attr("d", d3.line()
              .x(function(d) { return x(d.timestamp) })
              .y(function(d) { return y(d.value) })
            )
      }
  
      // If user double click, reinitialize the chart
      svg.on("dblclick",function(){
        x.domain(d3.extent(data, function(d) { return d.timestamp; }))
        xAxis.transition().call(d3.axisBottom(x))
        line
          .select('.line')
          .transition()
          .attr("d", d3.line()
            .x(function(d) { return x(d.timestamp) })
            .y(function(d) { return y(d.value) })
        )
      });
  
  }
  </script>
      </div> 
  </body>
</html>